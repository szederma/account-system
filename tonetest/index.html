<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Harmonic Synthesizer</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 2rem;
        background: #f6f6f6;
        color: #222;
      }
      h1 {
        font-size: 1.75rem;
        margin-bottom: 1rem;
      }
      label {
        font-weight: 600;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        margin-top: 1rem;
      }
      th,
      td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #fafafa;
      }
      input[type="number"] {
        width: 100%;
        padding: 0.25rem 0.4rem;
        box-sizing: border-box;
      }
      button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: #0077ff;
        color: #fff;
        transition: background 0.2s ease;
      }
      button:hover {
        background: #005fd1;
      }
      .small-button {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <h1>Harmonic Synthesizer</h1>

    <form id="harmonicsForm" onsubmit="return false;">
      <div class="controls">
        <label>Harmonics:</label>
        <span id="harmCount">6</span>
        <button type="button" id="addHarm" class="small-button">+</button>
        <button type="button" id="removeHarm" class="small-button">−</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Component</th>
            <th>Frequency (Hz)</th>
            <th>Intensity (0–1)</th>
            <th>Duration (s)</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <button type="button" id="playBtn">Play</button>
    </form>

    <script>
      let numHarm = 6;
      const rows = document.getElementById("rows");
      const harmCountLabel = document.getElementById("harmCount");

      function saveToLocalStorage() {
        const data = {
          numHarm,
          components: []
        };
        for (let i = 0; i <= numHarm; i++) {
          const freq = document.getElementById(`freq${i}`)?.value;
          const gain = document.getElementById(`gain${i}`)?.value;
          const dur = document.getElementById(`dur${i}`)?.value;
          if (freq && gain && dur) {
            data.components.push({ freq, gain, dur });
          }
        }
        localStorage.setItem("harmonicsData", JSON.stringify(data));
      }

      function loadFromLocalStorage() {
        const stored = localStorage.getItem("harmonicsData");
        if (stored) {
          try {
            const data = JSON.parse(stored);
            numHarm = parseInt(data.numHarm) || 6;
            renderRows();
            data.components.forEach((comp, i) => {
              document.getElementById(`freq${i}`).value = comp.freq;
              document.getElementById(`gain${i}`).value = comp.gain;
              document.getElementById(`dur${i}`).value = comp.dur;
            });
          } catch (e) {
            console.warn("Failed to load saved harmonics");
          }
        } else {
          renderRows();
        }
      }

      function renderRows() {
        const baseFreq = 440;
        harmCountLabel.textContent = numHarm;
        let html = "";

        html += `
          <tr>
            <td>Fundamental</td>
            <td><input type="number" id="freq0" min="20" max="20000" step="0.1" value="${baseFreq}" /></td>
            <td><input type="number" id="gain0" min="0" max="1" step="0.01" value="1" /></td>
            <td><input type="number" id="dur0" min="0.05" max="10" step="0.05" value="1" /></td>
          </tr>`;

        for (let i = 1; i <= numHarm; i++) {
          const defaultFreq = baseFreq * (i + 1);
          const defaultGain = (1 / (i + 1)).toFixed(2);
          html += `
            <tr>
              <td>Harmonic ${i}</td>
              <td><input type="number" id="freq${i}" min="20" max="20000" step="0.1" value="${defaultFreq}" /></td>
              <td><input type="number" id="gain${i}" min="0" max="1" step="0.01" value="${defaultGain}" /></td>
              <td><input type="number" id="dur${i}" min="0.05" max="10" step="0.05" value="1" /></td>
            </tr>`;
        }

        rows.innerHTML = html;
      }

      document.getElementById("addHarm").addEventListener("click", () => {
        if (numHarm < 20) {
          numHarm++;
          renderRows();
          saveToLocalStorage();
        }
      });

      document.getElementById("removeHarm").addEventListener("click", () => {
        if (numHarm > 0) {
          numHarm--;
          renderRows();
          saveToLocalStorage();
        }
      });

      document.getElementById("playBtn").addEventListener("click", () => {
        saveToLocalStorage();

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        const now = ctx.currentTime;

        for (let i = 0; i <= numHarm; i++) {
          const freqField = document.getElementById(`freq${i}`);
          const gainField = document.getElementById(`gain${i}`);
          const durField = document.getElementById(`dur${i}`);

          if (!freqField || !gainField || !durField) continue;

          const freq = parseFloat(freqField.value);
          const gainVal = parseFloat(gainField.value);
          const duration = parseFloat(durField.value);

          if (!(freq > 0 && gainVal > 0 && duration > 0)) continue;

          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.type = "sine";
          osc.frequency.value = freq;

          gain.gain.setValueAtTime(gainVal, now);
          gain.gain.setValueAtTime(gainVal, now + duration - 0.01);
          gain.gain.linearRampToValueAtTime(0.0001, now + duration);

          osc.connect(gain).connect(ctx.destination);
          osc.start(now);
          osc.stop(now + duration);
        }
      });

      loadFromLocalStorage();
    </script>
  </body>
</html>